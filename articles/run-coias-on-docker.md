---
title: "誰でも小惑星探索できるソフトCOIASを導入して起動するまで"
emoji: "🌟"
type: "tech" # tech: 技術記事 / idea: アイデア
topics:
    - COIAS
    - astronomy
published: true
---


:::message
本記事は、[東京大学きらら同好会 Advent Calendar 2022](https://adventar.org/calendars/7530) 3日目、[まんがタイムきらら Advent Calendar 2022](https://adventar.org/calendars/7455) 3日目の記事です。

きらら同好会カレンダーの昨日の記事は、「[わたしときららファンタジア](https://utkiraracircle.hatenablog.com/entry/watashi-kirafan)」でした。明日は、ひろみねさんの「[キャラソンからチノの成長を振り返る](https://mine-h.hatenablog.com/entry/2022/12/04/173529)」です。

まんがタイムきららカレンダーの明日の記事は、こはるなぎ まなかさんの「[10年前の2巻乙作品『ハームフル・ビューティフル』を考察しよう](https://vtuberstart.com/harmful-beautiful/)」です。
:::

# TL;DR
- COIASは、専門家でない人でも観測画像から新しい小惑星を発見できるソフトウェアです
- 2022年12月現在では、開発中のバージョンがDockerイメージとして配布されています
- 公式のガイドに従って、導入と基本操作を試しました

![](/images/coias/search-boxes.jpg)

# COIASとは
COIAS (Come On! Impacting ASteroid)は、**新しい小惑星を発見する**ためのソフトウェアです。⽇本スペースガード協会の浦川氏をはじめとする研究チームによって開発されています。

@[tweet](https://twitter.com/Madoka_Hoshimi/status/1587006463666536448)

小惑星を探すソフトウェアは従来もありましたが、COIASは探索の手順を自動化・GUI化し、**非専門家でも小惑星探索のプロセスを実施できる**点を特徴としています。天文教育や天文普及活動にも活用できるというわけです。

このCOIASのネーミングの由来の1つは、『**恋する小惑星（恋アス）**』という作品です。恋アスは高校の地学部に所属する木ノ幡みら・真中あおが、新しい小惑星を発見して名前を付けることを目指して活動する様子を描いた4コマ漫画で、2020年にTVアニメ化されました。天文・地質・気象といった地学の知識が数多く登場し、正確さにもこだわった描写が特徴です。

第3巻の後半（TVアニメの終盤）では、みらたちが「きら星チャレンジ」というイベントに参加し、**石垣島天文台で小惑星探しを体験する**展開があります。このイベントは実際に石垣島で毎年開催される高校生向けの研究体験「美ら星研究体験隊」をモデルにしていて、国立天文台の方も作品に協力してくださっています。

@[tweet](https://twitter.com/mangatimekirara/status/1221810288875294720)

作品をご存じない方は、ニコニコ静画にて原作の冒頭部分が公開されているので、ぜひご覧ください。

https://seiga.nicovideo.jp/comic/40132

COIASは2020年秋ごろから天文学に関する国内外の学会で発表され、恋アスファンの間でも大きな話題を呼びました。原作のQuro先生も反応していたのが面白かったですね。

@[tweet](https://twitter.com/mrpriconnetaro/status/1385152050011394048)

@[tweet](https://twitter.com/uoaaaoi/status/1327045840276389888)

COIASの開発はその後も進められ、2022年現在は**プロトタイプを誰でも試せる**状態になっています。本記事では、実際にCOIASを導入して動作させてみた経過をご報告します。

# 環境
- Windows 10
- Ubuntu 20.04.4 LTS (WSL2)
- Docker Desktop 4.15.0

# インストール
2022年12月現在、COIASはDockerイメージを通じて導入する仕組みになっています。Dockerやターミナルの操作が必要なのでご注意ください（それらの知識がなくとも、説明を読みながら進められるとは思います）。

導入方法は、会津大学宇宙情報科学研究センター（ARC-Space）のWebサイトに順を追って書いてあるので、それに沿って行えばよいです。

https://arcspace.jp/doku.php?id=ja:coias:top

（12/12追記）Fchisaさんが「[**MacにDocker DesktopとCOIASを導入して起動する**](https://note.com/fchisa/n/n15fd42275c05)」を執筆してくださいました！　Macをお使いの方はこちらも参考にしてみてください。

https://note.com/fchisa/n/n15fd42275c05

ここでは筆者が作業した流れを記録しておきます。
なお、COIAS自体が開発中のソフトウェアであるため、導入方法が今後変わる可能性は大いにあります。

## Docker（とWSL2）の導入
導入にはDockerとWSL2（Windowsのみ）が必要と書かれています。「Docker WSL2」でググって出てくる記事を参考に進めれば良いと思います。

https://zenn.dev/ttani/articles/wsl2-docker-setup

筆者の環境では導入済みでしたので、飛ばして進みました。

## インストールと起動
WSL2側のシェルを開いて、インストールコマンドを打ちます。実行した場所の下に`coias-app`というフォルダが作られるので、配置したいディレクトリがあればそこに移動してからのほうがいいでしょう。

```bash
$ curl -sf https://raw.githubusercontent.com/coias/coias-docker-compose/main/code-run | bash -s
```

Dockerイメージが取得されるのでしばらく待ちます。

```
[+] Running 3/3
 ⠿ Container coias-imagehost-container  Started
 ⠿ Container coias-front-container      Started
 ⠿ Container coias-back-container       Started
```

上のようにStartedという表示が出れば起動が進んでいます。Webアプリ（{coias-front-container}）のビルドに少し時間がかかるので、30秒～1分ほど待ってあげるとよいでしょう（終わっていない場合、ブラウザで開いてもアプリが表示されません）。

http://localhost:3000 を開きます。

![](/images/coias/coias-start.png)

無事にCOIASが起動しました。

![](/images/coias/coias-start-2.png)

アイコンはQuro先生の描き下ろしらしいです。最高ですね。

:::message
~~注意点があります。127.0.0.1というIPアドレスでもローカルホストにアクセスできますが、IPアドレスでCOIASを開いてしまうと、**画像の解析から先がエラーで進めない状態**になりました。これは、Docker Desktopのコンテナ一覧に出ているリンクをクリックしてブラウザを開いた場合に起こります。~~
~~必ず`localhost:3000`を開くようにしましょう。~~

12月5日追記：本件はCORS（クロスオリジンリソース共有）絡みのエラーでした。
[開発リポジトリにissueを提起したところ](https://github.com/coias/coias-back-app/issues/24)、速やかに対応していただいたので、127.0.0.1を開いてもエラーなく使えるようになりました。
ただ、COIASを実行しているマシン以外からフロントエンドにアクセスすると、同様にCORSのエラーで使えないと考えられます。ご注意ください。
:::

## 2回目以降の起動
`coias-app`ディレクトリでDockerのコマンドを打って立ち上げます。`-d`オプションを付けるとdetachedモード、つまり起動後はターミナルに次のコマンドを打てる状態になります。

```bash
$ cd coias-app
$ docker-compose up -d
```

## 停止
detachedモードで立ち上げた場合、ブラウザでCOIASの画面を閉じてもDockerコンテナは裏で動いています。これを止めたい場合は、Docker Desktopのウィンドウで停止ボタンを押すか、コマンドで停止します。

![](/images/coias/container-stop.png)


コマンドの場合は、`docker-compose down`（コンテナの削除）もしくは`docker-compose stop`（コンテナの一時停止）を使いましょう。

```bash
$ docker-compose down
```

# 使ってみる
## 画像データの入手
COIASは、起動しただけでは観測画像データがないため空っぽの状態です。実際の観測画像を入手する必要があります。

> 現状はプロトタイプであり、お問合せがあった方のみ、試験データを提供しています。試験データの提供に際してお名前とメールアドレスをお聞きします。ご了承いただいた方のみにデータ提供をしています。

ということなので、今すぐに使ってみたい方は[公式ページの下部](https://arcspace.jp/doku.php?id=ja:coias:top#%E3%81%9D%E3%81%AE%E4%BB%96)にある問い合わせアドレスに身分を明かして提供を依頼しましょう。

提供頂いた試験データは、`warp-HSC-R-9464-3,6-34780.fits`のようなファイル名でした。これは、**天文学の分野でよく使われるFITSという形式の画像データ**です。天文学の観測データを表すのに適した構造になっています。

## ファイルのアップロード
「ファイル」ボタンから、試験データ5枚を選択してアップロードしてみます。処理方法は、規定の設定で進める**全自動処理**と、自分で各手順を確認しながら進める**手動処理**があります。本記事では全自動処理を試します。

![](/images/coias/load-imgs.png)

## 全自動処理
アップロードに成功すると「ファイル」ボタンが緑色に変わり、中央のスペースにファイル名が表示されます。「全自動処理」ボタンで分析をスタートします。

![](/images/coias/loaded-file.png)

「処理は時間がかかります」と記されているとおり、全自動処理にはそれなりに待ち時間があるのでお茶でも飲みながら待ちましょう。筆者の環境（CPU: Ryzen 7 3700X, RAM: 32GB, WSLに割り当てたRAM: 4GB）で試験データ5枚の分析に9分くらいかかりました。

分析中はCPUを結構使っていた様子なので、できれば**CPUパワーに余裕のある環境**で実行してあげるのがよいでしょう。

:::message
COIASは全自動処理のときにCPUをそれなりに使用しますが、**高性能なパソコンが必須というわけではありません**。ノートパソコンでも動くのでご安心ください。
例えば、筆者が2017年発売のMacbook Pro（CPU: Core-i5）でも試したところ、最新のCPUよりは少し分析時間が伸びましたが、無事に処理が完了しました。メモリも4GB割り当てれば十分でした。
目安として、ここ数年に出ていてオフィス作業等に支障がないパソコンであれば、問題なくCOIASを動作させられると思われます。
:::

![](/images/coias/analyzing.png)
*分析中は現在行っている処理内容が表示される*

## 小惑星探索
処理が成功すると、「探索/再描画」画面に移るボタンが押せるようになっているので押します。

![](/images/coias/search-button.png)

なにやら黒いボックスがたくさん出ている画面になりました。これらは、**新天体の可能性がある光点**（および、既知の天体）が自動検出された結果です。

![](/images/coias/search-boxes.jpg)

なお、ここからはVTuberの星見まどか氏の配信動画で、実際の動作の様子がみられます。見比べながら進めるとやりやすいと思います。

https://www.youtube.com/watch?v=r7DYq9m7TK4&t=3823s

動画でも説明されているとおり、これらのボックスには**新天体ではないノイズも混じっています**。小惑星候補とノイズを仕分けなければなりません。

小惑星は太陽の周りを周って移動しているので、連続撮影した画像を見比べるとある方向に移動して見えます。この特徴を利用して、撮影時刻の違う画像を連続して切り替える**ブリンク**という操作で、移動している光点を絞り込む作業が必要です。

左上の▶ボタン（または`s`キー）を押すとGIFアニメのように連続再生が始まります。デフォルトの0.01秒間隔では点滅が速すぎて目がチカチカしてしまうため、0.1秒間隔くらいが見やすいと感じました。

移動する小惑星だと思ったボックスをクリックすると、赤色に色が変わります。たまにクリックできないボックスがありますが、それらは**既知の小惑星**で、新天体ではないと判定されたものです。

この操作を繰り返して小惑星候補の選択を終えたら、右下の「再描画」ボタンを押して**小惑星候補だけが表示された状態**にします（なにやら設定画面が出てきますが、特に何もせず進んでもOKです）。

![](/images/coias/repaint.jpg)

再描画すると画面がスッキリするので、ここでもう一度ブリンク再生してミスがないか確認するといいでしょう。

![](/images/coias/repainted-boxes.gif)

## 手動測定と名前修正
再描画の結果に満足したら、「手動測定/名前修正」画面に移ります。ここでは、自動検出されなかった天体を自分で囲んで新天体として報告できます。

今回は、特に何もせずに最後のレポート作成へ進みました（もう一度「再描画」をするとレポート画面へのボタンが押せます）。

## レポート作成
COIASの素晴らしい点の一つは、**新しい小惑星を報告するためのレポートを自動生成**してくれることです。この画面で、レポート内容のプレビューと、2種類のレポートファイルのダウンロードができます。

![](/images/coias/reporting.png)

# まとめ
小惑星探索アプリCOIASを実際に使用してみました。Dockerを使うので導入部分のハードルはまだあるかもしれませんが、今後Webアプリとしてのリリースが検討されているそうで楽しみです。
