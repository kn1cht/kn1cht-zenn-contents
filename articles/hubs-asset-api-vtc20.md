---
title: "Hubsã«è²¼ã‚Šä»˜ã‘ãŸãƒ¡ãƒ‡ã‚£ã‚¢ã‚’å¤–éƒ¨ã‹ã‚‰å·®ã—æ›¿ãˆå¯èƒ½ã«ã™ã‚‹Web API"
emoji: "ğŸ¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - vr
  - hubs
  - firebase
published: false
---

ã“ã®è¨˜äº‹ã¯ã€[**Hubs Advent Calendar 2020**](https://qiita.com/advent-calendar/2020/hubs) 11æ—¥ç›®ã®è¨˜äº‹ã§ã™ï¼ˆå¤§é…åˆ»ã™ã¿ã¾ã›ã‚“ï¼‰ã€‚

https://qiita.com/advent-calendar/2020/hubs

---

# TL;DR
- Hubsä¸Šã§è¡¨ç¤ºã•ã‚Œã‚‹ç”»åƒã‚„å‹•ç”»ãªã©ã®**ãƒ¡ãƒ‡ã‚£ã‚¢URLã‚’å¤–éƒ¨ã‹ã‚‰æŒ‡å®šã§ãã‚‹**APIã‚’ä½œã‚Šã¾ã—ãŸ
- **Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ›´æ–°ã™ã‚‹ã ã‘**ã§ã€è¿…é€Ÿã«ãƒ¡ãƒ‡ã‚£ã‚¢ã®è¨­ç½®ãƒ»å·®ã—æ›¿ãˆãŒå®Œäº†ã—ã¾ã™
- Google Firebaseç”¨ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¬é–‹ã—ã¦ã„ã¾ã™

[![](https://storage.googleapis.com/zenn-user-upload/n0bt3leahwj58rkjpqiokfemyuiz =350x)](https://github.com/kn1cht/hubs-asset-api-firebase)

# ã¯ã˜ã‚ã«

2020å¹´10æœˆã€GREE VR Studio Laboratoryä¸»å‚¬ã®VRãƒãƒƒã‚«ã‚½ãƒ³ã€Œ[**VTech Challenge 2020**ï¼ˆVTC20ï¼‰](https://vr.gree.net/lab/vtc/vtc20/)ã€ãŒé–‹å‚¬ã•ã‚Œã€ã‚½ãƒ¼ã‚·ãƒ£ãƒ«VRã€Œ[Hubs](http://hubs.mozilla.com/)ã€ã«é–¢ã™ã‚‹ä½œå“ã‚„çŸ¥è¦‹ãŒæŠ«éœ²ã•ã‚Œã¾ã—ãŸã€‚
ç­†è€…ã¯ã€Œç ”ç©¶å®¤ã®æˆæœã‚’åºƒãä¼ãˆã‚‹ãƒãƒ¼ãƒãƒ£ãƒ«å±•ç¤ºå®¤ã€ã¨ã„ã†ãƒ†ãƒ¼ãƒã§ç™ºè¡¨ã—ã€å¹…åºƒã„å±¤ã®æ–¹ãŒå‚åŠ ã™ã‚‹ãƒãƒ¼ãƒãƒ£ãƒ«å±•ç¤ºã¨ã„ã†ç›®çš„ã«æ²¿ã£ãŸå·¥å¤«ã‚’ãŠè©±ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/mal9ckv0gxd8jsd33m43prybkuwq =550x)
*Hubsã«è¨­ç½®ã—ãŸã‚¹ãƒ©ã‚¤ãƒ‰ç”»åƒã‚’å‰ã«è­°è«–ã—ã¦ã„ã‚‹æ§˜å­*

HubsãŒç”»åƒã‚„å‹•ç”»ã€ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’å¤šç”¨ã™ã‚‹ç™ºè¡¨ã«å‘ã„ã¦ã„ã‚‹ç†ç”±ã®1ã¤ã«ã€**ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§ç°¡å˜ã«VRç©ºé–“ã¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–ã‚Šè¾¼ã‚ã‚‹**ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
ã—ã‹ã—ã€ç ”ç©¶å®¤ã®å­¦ç”Ÿå…¨å“¡ãªã©å¤šãã®äººã‹ã‚‰ã®è³‡æ–™ã‚’ä¸€æ–‰ã«å–ã‚Šè¾¼ã‚€ã‚ˆã†ãªçŠ¶æ³ã§ã¯ã€**3Dç©ºé–“ã§ã®é…ç½®ä½œæ¥­ã®æ‰‹é–“**ãŒç„¡è¦–ã§ãã¾ã›ã‚“ï¼ˆãƒ¡ãƒ‡ã‚£ã‚¢ã‚’å¸ç€ã™ã‚‹Media FrameãŒå®Ÿè£…ã•ã‚Œã¦æ¥½ã«ã¯ãªã‚Šã¾ã—ãŸãŒï¼‰ã€‚VRã‚¤ãƒ™ãƒ³ãƒˆå½“æ—¥ã‚ˆã‚Šå‰ã«ååˆ†ä½™è£•ã‚’æŒã£ã¦é…ç½®ä½œæ¥­ã‚’ã§ãã‚Œã°ã‚ˆã„ã§ã™ãŒã€**é–‹å§‹ã‚®ãƒªã‚®ãƒªã«æå‡ºã•ã‚ŒãŸã‚Šã€å†…å®¹ãŒæ€¥é½å·®ã—æ›¿ãˆã«ãªã£ãŸã‚Š**ã—ã¦ã‚‚è¿…é€Ÿã«è³‡æ–™ã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§ãã‚‹ã¨ã‚¹ãƒ ãƒ¼ã‚ºã§ã™ã€‚

ãã“ã§ã€Hubsã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã„ã£ãŸã‚“ãƒ€ãƒŸãƒ¼ã®URLã§å—ã‘å–ã‚Šã€**Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜è¼‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®URLã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹API**ã€Œ[hubs-asset-api](https://github.com/kn1cht/hubs-asset-api-firebase)ã€ã‚’ä½œã‚Šã¾ã—ãŸã€‚
hubs-asset-apiã¯Google Firebaseã§å‹•ã„ã¦ãŠã‚Šã€ãƒ€ãƒŸãƒ¼URLã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚ã‚‹ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’å‚ç…§ã—ã¦ã€ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹URLã¸ã®302ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’è¿”ã™ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/z56edftau89nghe7xjiujtnsfaee)

hubs-asset-apiã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®ã“ã¨ãŒå®Ÿç¾ã—ã¾ã™ã€‚

1. Hubsã‚·ãƒ¼ãƒ³å†…ã¸ã®**ãƒ¡ãƒ‡ã‚£ã‚¢ã®å–ã‚Šè¾¼ã¿ãŒGoogleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ç·¨é›†ã ã‘**ã§å®Œäº†ã™ã‚‹ï¼ˆä½œæ¥­è² æ‹…è»½æ¸›ãƒ»ä½ç½®ã‚’èª¤ã£ã¦å‹•ã‹ã™ãªã©ã®ãƒŸã‚¹å›é¿ï¼‰
1. ãƒ¡ãƒ‡ã‚£ã‚¢ã‚’æ›´æ–°ã™ã‚‹éš›ã‚‚ã€**ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ç·¨é›†ã™ã‚‹ã ã‘ã§æœ€æ–°ã®å†…å®¹ã«**ç½®ãã‹ã‚ã‚‹ï¼ˆãƒ¡ãƒ‡ã‚£ã‚¢ã®ç½®ãç›´ã—ã‚„Spokeã§ã®å†ç·¨é›†ä¸è¦ï¼‰
1. Spokeã§ã®**Hubsã‚·ãƒ¼ãƒ³åˆ¶ä½œæ‹…å½“**ã¨ã€ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™æ‹…å½“ã®åˆ†æ¥­

æœ¬è¨˜äº‹ã§ã¯ã€VTC20ã§ãŠè©±ã—ãã‚Œãªã‹ã£ãŸhubs-asset-apiã®ä¸­èº«ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚

# èƒŒæ™¯
## å„ç¨®ã‚½ãƒ¼ã‚·ãƒ£ãƒ«VRã§ã®ãƒ¡ãƒ‡ã‚£ã‚¢ã®æ‰±ã„

ã‚½ãƒ¼ã‚·ãƒ£ãƒ«VRã§ãƒ¡ãƒ‡ã‚£ã‚¢ã‚’å–ã‚Šè¾¼ã‚€æ–¹æ³•ã¯æ§˜ã€…ã§ã™ã€‚
**VRChat**ã§ã¯ã€ç”»åƒã‚„3Dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯**äº‹å‰ã«ãƒ¯ãƒ¼ãƒ«ãƒ‰ã‹ã‚¢ãƒã‚¿ãƒ¼ã«Unityã§çµ„ã¿è¾¼ã‚“ã§ãŠã**ã®ãŒåŸå‰‡ã§ã™ã€‚ä¾‹å¤–ã¨ã—ã¦ã€[`VRC_Panorama`](https://docs.vrchat.com/docs/vrc_panorama)ãªã©URLã‚’å‚ç…§ã§ãã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒã‚ã‚Šã€[è‡ªå‹•æ›´æ–°ã•ã‚Œã‚‹æ²ç¤ºç‰©](https://booth.pm/ja/items/2401621)ãªã©ã«å¿œç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
**cluster**ã§ã¯ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãŠã„ãŸ**ç”»åƒãƒ»å‹•ç”»ãƒ»PDFãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã«è¡¨ç¤º**ã•ã‚Œã€ã‚¤ãƒ™ãƒ³ãƒˆä¼šå ´ã®ç”»é¢ã«å‡ºåŠ›ã§ãã¾ã™ã€‚ã—ã‹ã—ã€ãƒ¯ãƒ¼ãƒ«ãƒ‰å†…ã®å¥½ããªå ´æ‰€ã«ãƒ¡ãƒ‡ã‚£ã‚¢ã‚’è¨­ç½®ã™ã‚‹ã‚ˆã†ãªæ©Ÿèƒ½ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆãƒ¯ãƒ¼ãƒ«ãƒ‰è‡ªä½“ã«çµ„ã¿è¾¼ã‚€ã“ã¨ã¯å¯èƒ½ï¼‰ã€‚
**Neos VR**ã¯è‡ªç”±åº¦ãŒãŸã„ã¸ã‚“é«˜ãã€**ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‚„PCã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–ã‚Šå‡ºã—**ã€æ‰‹ã«æŒã£ãŸã‚Šé…ç½®ã—ãŸã‚Šã§ãã¾ã™ã€‚

## Hubsã®ãƒ¡ãƒ‡ã‚£ã‚¢è¡¨ç¤ºã¯Webãƒªãƒ³ã‚¯ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼

Hubsã§ã¯ã€**ç”»åƒãƒ»å‹•ç”»ãƒ»PDFãªã©ã®ãƒ¡ãƒ‡ã‚£ã‚¢ã‚„Webãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯**ã‚’3Dç©ºé–“ã«å–ã‚Šè¾¼ã‚ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãŒä½¿ãˆã‚‹ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã¯ãªã„ã‚‚ã®ã®ã€Neos VRã¨åŒæ§˜ã«ç©ºé–“ã§ã®ç§»å‹•ãƒ»é…ç½®ãŒè‡ªç”±è‡ªåœ¨ã«ã§ãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/xikh29n3jwyxy1w4a3iu67erqw9x)


ã‚ãŸã‹ã‚‚ãƒ¡ãƒ‡ã‚£ã‚¢ãŒVRã«å–ã‚Šè¾¼ã¾ã‚ŒãŸã‚ˆã†ã«è¦‹ãˆã„ã¾ã™ãŒã€Hubsã¯Webãƒ™ãƒ¼ã‚¹ã®æŠ€è¡“ã§ã§ãã¦ã„ã‚‹ã®ã§ã€VRå†…ã§è¦‹ãˆã¦ã„ã‚‹**ç”»åƒã‚„å‹•ç”»ã¯ãã‚Œãã‚ŒWebãƒªãƒ³ã‚¯**ã§ã™ã€‚ãã®è¨¼æ‹ ã«ã€Tabã‚­ãƒ¼ã‹Spaceã‚­ãƒ¼ãƒ›ãƒ¼ãƒ«ãƒ‰ã§ãƒ¡ãƒ‡ã‚£ã‚¢ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ãã¨ã€`Open link`ãƒœã‚¿ãƒ³ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«è‡ªä½“ã®URLã«é£›ã¹ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/rs7hryn5cd07eadhvfnmdlewwzq1 =500x)
*`Open link`ãƒœã‚¿ãƒ³*

Slackã‚„Discordãªã©ã§ã‚‚ã€ç”»åƒã®URLã‚’è²¼ã‚Šä»˜ã‘ãŸã‚‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå±•é–‹ã•ã‚Œã¾ã™ã€‚2Dç”»é¢ã¨3Dã®VRç©ºé–“ã¨ã„ã†é•ã„ãŒã‚ã‚‹ã ã‘ã§ã€å®Ÿæ…‹ã¯ã©ã¡ã‚‰ã‚‚**ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®URLã‚’è¦‹ã‚„ã™ãè¡¨ç¤ºã—ã¦ã„ã‚‹ã ã‘**ã¨è¨€ãˆã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/zu7ayn47e6uouffdwzlka1gb8snj)
*ã©ã¡ã‚‰ã‚‚Webãƒªãƒ³ã‚¯å…ˆã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ã„ã†ç‚¹ã§ã¯åŒã˜*

Hubsã§ã¯ã€Hubsã‚µãƒ¼ãƒã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸã‚‚ã®ä»¥å¤–ã®URLã‚’è²¼ã£ã¦ã‚‚ãƒ¡ãƒ‡ã‚£ã‚¢ã¨ã—ã¦å±•é–‹ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã¯ã€**Webã§å…¬é–‹ã•ã‚Œã¦ã„ã‚‹URLã•ãˆã‚ã‚Œã°ã€ã©ã“ã«ã‚ã‚‹ç”»åƒã‚’è²¼ã£ã¦ã‚‚VRå†…ã§è¡¨ç¤ºã•ã‚Œã‚‹**ã¨ã„ã†ã“ã¨ã§ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/gxtgbb5482dn6norrhm3tzrp0dai)
*github.comã§ãƒ›ã‚¹ãƒˆã•ã‚Œã¦ã„ã‚‹ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’è²¼ã‚Šä»˜ã‘ãŸæ§˜å­*

ãã—ã¦ã€URLã®ãƒªãƒ³ã‚¯å…ˆã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãŒã‚ã‚‹å ´åˆã€**Hubsã¯ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆã¾ã§è¦‹ã«è¡Œã£ã¦ãã‚Œã¾ã™**ã€‚hubs-asset-apiã¯ã€ãƒ€ãƒŸãƒ¼ã®URLã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã®å®Ÿä½“URLã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã›ã‚‹ã“ã¨ã§ã€å¤–éƒ¨ã‹ã‚‰èª­ã¿è¾¼ã¾ã‚Œã‚‹ãƒ¡ãƒ‡ã‚£ã‚¢ã‚’æ“ä½œã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/v60y5gd7dtmzfau12xn71ipnwf7t)


# APIã®å®Ÿè£…

## ã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹é¸å®š
hubs-asset-apiã«æœ€ä½é™å¿…è¦ãªæ©Ÿèƒ½ã¯ä»¥ä¸‹ã®2ç‚¹ã§ã™ã€‚

1. ãƒ€ãƒŸãƒ¼URLã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«**302ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã§å®Ÿä½“URLã‚’è¿”ã™**
1. ãƒ€ãƒŸãƒ¼URLã‚’ã‚‚ã¨ã«ã€**å®Ÿä½“URLã‚’Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰å–å¾—ã™ã‚‹**

å¾Œè€…ã®Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¨ã®ç›¸æ€§ã‚’è€ƒãˆã¦ã€GoogleãŒæä¾›ã™ã‚‹ã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ã†ã“ã¨ã«ã—ã¾ã—ãŸã€‚Googleã®ã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã«ã¯ç„¡æ–™æ ãŒã‚ã‚‹ã®ã§ã€**å°è¦æ¨¡ã®åˆ©ç”¨ãªã‚‰è²»ç”¨ã‚’ã‹ã‘ãšã«ç¶­æŒã§ãã‚‹**ã®ã‚‚åˆ©ç‚¹ã§ã—ãŸã€‚

ã‚‚ã£ã¨ã‚‚ç°¡å˜ã«Webã‚¢ãƒ—ãƒªã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹Googleã‚µãƒ¼ãƒ“ã‚¹ã¨ã„ãˆã°
Google Apps Scriptï¼ˆGASï¼‰ã§ã™ãŒã€[**GASã§è¿”ã›ã‚‹HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯200ã®ã¿**](https://issuetracker.google.com/issues/36759757)ã§ã€ä»»æ„ã®URLã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã›ã‚‹ã‚ˆã†ãªä½¿ã„æ–¹ã¯ã§ãã¾ã›ã‚“ã€‚ãã“ã§ã€ãƒ¢ãƒã‚¤ãƒ«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆmBaaSï¼‰ã®[Firebase](https://firebase.google.com/)ã‚’é¸å®šã—ã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/muotvoi7wtwc34jzrdndorvqw56g =500x)

hubs-asset-apiã§ã¯ã€Firebaseã®æ©Ÿèƒ½ã®ã†ã¡ã€URLã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãªã©ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼ã«å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹**Cloud Functions**ã‚’ä¸»ã«ä½¿ç”¨ã—ã¾ã™ã€‚Cloud Functionsã¯ã€å¾“é‡åˆ¶èª²é‡‘ã®Blazeãƒ—ãƒ©ãƒ³ã§ãªã„ã¨ä½¿ç”¨ã§ããªã„ã®ã§æ³¨æ„ã—ã¾ã—ã‚‡ã†ã€‚å¾“é‡åˆ¶ã¨è¨€ã£ã¦ã‚‚ã€[ã‹ãªã‚Šã‚†ã‚‹ã„åˆ¶é™ã®ç„¡æ–™æ ](https://firebase.google.com/pricing)ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€å€‹äººçš„ã«ä½¿ã†ç¨‹åº¦ã§ã¯ã»ã¼ç„¡æ–™ã«åã¾ã‚Šã¾ã™ï¼ˆã¾ã•ã‹ã®èª²é‡‘ã«æ°—ä»˜ã‘ã‚‹ã‚ˆã†ã€äºˆç®—ã‚¢ãƒ©ãƒ¼ãƒˆã¯å¿…ãšè¨­å®šã—ã¦ãŠãã¾ã—ã‚‡ã†ï¼ï¼‰ã€‚

## å®Ÿè£…è§£èª¬

https://github.com/kn1cht/hubs-asset-api-firebase ã§å…¬é–‹ã—ã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚ã„ã‚ã„ã‚ã¨ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã™ãŒã€Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å¿…è¦ãªè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç­‰ãŒã»ã¨ã‚“ã©ã§ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰è‡ªä½“ã¯`functions/index.js`ã¨`functions/store.js`ã ã‘ã§ã™ã€‚

[![](https://storage.googleapis.com/zenn-user-upload/n0bt3leahwj58rkjpqiokfemyuiz =350x)](https://github.com/kn1cht/hubs-asset-api-firebase)

### index.js

ãƒ€ãƒŸãƒ¼URLã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚Šã¾ã™ã€‚ãƒ€ãƒŸãƒ¼URLã®ãƒ‘ã‚¹ã¯ã©ã‚“ãªæ–‡å­—åˆ—ã§ã‚‚ã„ã„ã®ã§ã™ãŒã€ç­†è€…ã¯`/A-01.png`ã®ã‚ˆã†ãªãƒ•ã‚¡ã‚¤ãƒ«åã«ã—ã¾ã—ãŸã€‚

```js:index.js
exports.httpEvent = functions.https.onRequest(async (req, res) => {
  const filename = req.path.split('/')[1];
```

ãƒ€ãƒŸãƒ¼ã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—ã—ãŸã‚‰ã€Google Sheets APIã§URLãŒæ›¸ã‹ã‚ŒãŸã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’èª­ã¿ã«è¡Œãã¾ã™â€¦â€¦ã¨è¨€ã„ãŸã„ã¨ã“ã‚ã§ã™ãŒã€[**Sheets APIã«ã¯ã‚¢ã‚¯ã‚»ã‚¹é »åº¦ã®ãƒªãƒŸãƒƒãƒˆãŒã‚ã‚‹**](https://developers.google.com/sheets/api/limits)ãŸã‚1ç§’ã«ä½•åº¦ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‚ã‘ã«ã¯ã„ãã¾ã›ã‚“ã€‚ãã“ã§ã€Firebaseã§æä¾›ã•ã‚Œã¦ã„ã‚‹NoSQLã®**Cloud Firestore**ã«ã‚·ãƒ¼ãƒˆã®å†…å®¹ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

```js:index.js
  const sheetData = await store.getDocInCollection('sheet', 0);
  const updatedMillis = sheetData.updatedAt ? sheetData.updatedAt.toMillis() : 0;
  const elpsedTimeSec = (new Date().getTime() -  updatedMillis) / 1000;

  let sheetVals = JSON.parse(sheetData.vals || '{}');
```

ãã®ä¸Šã§ã€ã‚¢ã‚¯ã‚»ã‚¹æ™‚ç‚¹ã§**Firestoreã®æœ€çµ‚æ›´æ–°ã‹ã‚‰60ç§’**éãã¦ã„ã‚‹å ´åˆã¯Sheets APIã‚’ä½¿ã£ã¦ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä¸­èº«ã‚’å–å¾—ã—ã¾ã™ã€‚å½“ç„¶Firestoreã®æ–¹ã‚‚æ›´æ–°ã—ã¾ã™ã€‚
`getSpreadSheetValsFromApi()`é–¢æ•°ã¯Sheets APIã‚’ä½¿ã£ã¦ã„ã‚‹ã ã‘ãªã®ã§çœç•¥ã—ã¾ã™ã€‚

```js:index.js
  if(elpsedTimeSec >= 60 || Object.keys(sheetVals).length === 0) {
    sheetVals = await getSpreadSheetValsFromApi();
    await store.setDocInCollection('sheet', 0, {
      updatedAt: firestore.FieldValue.serverTimestamp(),
      vals: JSON.stringify(sheetVals)
    });
  }
```

æœ€å¾Œã«ãƒ€ãƒŸãƒ¼URLã®åˆ—ã‹ã‚‰è©²å½“ã™ã‚‹è¡Œã‚’æ¤œç´¢ã—ã€å®Ÿä½“URLã®åˆ—ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ãŒç½®ã‹ã‚Œã¦ã„ã‚‹URLã‚’å–ã‚Šå‡ºã—ã¦ã€302ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã¨ã—ã¦è¿”ã—ã¾ã™ã€‚ã€Œãƒ€ãƒŸãƒ¼URLã®åˆ—ã€ã€Œå®Ÿä½“URLã®åˆ—ã€ãŒå·¦ã‹ã‚‰ä½•ç•ªç›®ãªã®ã‹ã¯ã€`functions/config/default.yaml`ã§è¨­å®šã§ãã¾ã™ã€‚

```js:index.js
  const urlIndex = sheetVals[config.fileColumnNo].indexOf(filename);
  res.redirect(302, sheetVals[config.urlColumnNo][urlIndex]);
});
```

### store.js

Cloud Firestoreã‚’èª­ã¿æ›¸ãã™ã‚‹ãŸã‚ã®å®Ÿè£…ã§ã™ã€‚ç‰¹ã«å¤‰ã‚ã£ãŸã“ã¨ã¯ã—ã¦ã„ãªã„ã®ã§ã€ã‚³ãƒ¼ãƒ‰ã¯æŠ˜ã‚ŠãŸãŸã‚“ã§ã„ã¾ã™ã€‚
Cloud Functionsã§ã¯ã€`firebase-admin`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚€ã¨Firestoreã¸ç°¡å˜ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¦æ¥½ã§ã™ã€‚

:::details store.js

```js:store.js
'use strict';

const admin = require('firebase-admin');
admin.initializeApp();

class Store {
  constructor() {
    this.db = admin.firestore();
  }

  async getDocInCollection(cName, dName) {
    const doc = await this.db.doc(`${cName}/${dName}`)
      .get().catch((err) => console.error(err));
    return (doc.exists ? doc.data() : {});
  }

  async setDocInCollection(cName, dName, data) {
    await this.db.doc(`${cName}/${dName}`)
      .set(data).catch((err) => {
        console.error(err);
        return false;
      });
    return true;
  }
}

module.exports = Store;
```

:::

## ãƒ‡ãƒ—ãƒ­ã‚¤

ï¼ˆ[README](https://github.com/kn1cht/hubs-asset-api-firebase/blob/master/README.md)ã«è©³ã—ã„æ‰‹é †ã‚’è¨˜è¼‰ã—ã¦ã„ã¾ã™ï¼‰

Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦CLIã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã€URLç·¨é›†ç”¨ã®Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãŠãã¾ã™ã€‚è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®IDã‚„ã‚·ãƒ¼ãƒˆåã€åˆ—ç•ªå·ã‚’æ›¸ãè¾¼ã¿ã¾ã™ã€‚

```bash
$ cp functions/config/example.yaml functions/config/default.yaml
$ vi functions/config/default.yaml
```

[GCP Console](https://console.cloud.google.com/apis/library/sheets.googleapis.com)ã§Google Sheets APIã‚’æœ‰åŠ¹åŒ–ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/epwnyygdjfc713s91s6zka89htal =500x)

Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚‰å®Œäº†ã§ã™ã€‚ãƒ€ãƒŸãƒ¼ã®URLã¸ãƒ–ãƒ©ã‚¦ã‚¶ç­‰ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€ãã¡ã‚“ã¨ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

```bash
$ firebase deploy
```

